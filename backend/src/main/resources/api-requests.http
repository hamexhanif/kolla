### ===================================================================
### SCHRITT 1: AUTHENTIFIZIERUNG
### ===================================================================

### Login als Manager (für Admin-Aktionen)
# Führe diesen Request zuerst aus, um einen Admin-Token zu erhalten.
# @name loginAsManager
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "email": "admin@kolla.com",
  "password": "adminpassword"
}

> {%
    client.global.set("manager_token", response.body.token);
    client.log("Manager Token gesetzt: " + response.body.token);
%}


### Login als normaler Benutzer (Akteur/Worker)
# @name loginAsUser
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "email": "dev@kolla.com",
  "password": "devpassword"
}

> {%
    client.global.set("user_token", response.body.token);
    client.log("User Token gesetzt: " + response.body.token);
%}


### ===================================================================
### ENDPUNKTE FÜR DEN WORKFLOW MANAGER
### ===================================================================
# Diese Endpunkte sollten nur von einem eingeloggten Manager aufgerufen werden.

### A. Dashboard-Daten für den Manager abrufen
GET http://localhost:8080/api/manager/dashboard
Authorization: Bearer {{manager_token}}


### B. Neuen Task erstellen
POST http://localhost:8080/api/tasks
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "title": "Neues Design finalisieren",
  "description": "Das neue UI-Design muss fertiggestellt werden.",
  "deadline": "2026-02-15T18:00:00",
  "workflowDefinitionId": 1,
  "creatorUserId": 1
}
### Ruft den detaillierten Fortschritt für einen einzelnen Task ab
# Entspricht der getTaskProgress()-Methode.
# Nützlich für eine dedizierte Fortschrittsanzeige.
GET http://localhost:8080/api/tasks/1/progress
Authorization: Bearer {{manager_token}}


### Ruft ALLE Details für einen einzelnen Task ab
# Entspricht der getTaskDetails()-Methode.
# Perfekt für die "Task One - Details" Ansicht im Frontend-Mockup.
GET http://localhost:8080/api/tasks/1/details
Authorization: Bearer {{manager_token}}


### C. Alle Benutzer verwalten (CRUD)
# C.1 Alle verfügbaren Rollen abrufen (für Dropdowns)
GET http://localhost:8080/api/roles
Authorization: Bearer {{manager_token}}

### C.2 Alle Benutzer abrufen
GET http://localhost:8080/api/users
Authorization: Bearer {{manager_token}}

### C.3 Neuen Benutzer erstellen
POST http://localhost:8080/api/users
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "email": "neuer.mitarbeiter@kolla.com",
  "password": "password123",
  "username": "neuermitarbeiter",
  "firstName": "Neu",
  "lastName": "Mitarbeiter",
  "tenantId": 1,
  "roleIds": [2]
}

### C.4 Benutzer aktualisieren (z.B. den eben erstellten mit ID 4)
PUT http://localhost:8080/api/users/4
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "username": "neuer_mitarbeiter_updated",
  "email": "neu.updated@kolla.com",
  "roleIds": [2, 3]
}

### C.5 Benutzer löschen (z.B. ID 4)
DELETE http://localhost:8080/api/users/4
Authorization: Bearer {{manager_token}}


### D. Manuelle Priorität für einen Task-Schritt setzen
POST http://localhost:8080/api/task-steps/2/set-priority
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "manualPriority": 1
}


### ===================================================================
### ENDPUNKTE FÜR DEN AKTEUR (Normaler Benutzer/Worker)
### ===================================================================
# Diese Endpunkte sollten mit dem Token eines normalen Benutzers aufgerufen werden.

### A. Persönliche Aufgabenliste abrufen ("My Tasks")
## WICHTIG: Führe zuerst den "loginAsUser"-Request aus!
GET http://localhost:8080/api/users/2/tasks
Authorization: Bearer {{user_token}}

# Debug: Was ist user_token?
# {{user_token}}

### B. Einen Arbeitsschritt abschließen
# Simuliert, dass der "developer" (userId: 2) den ersten Schritt (stepId: 1) abschließt.
# WICHTIG: Führe zuerst den "loginAsUser"-Request aus!
POST http://localhost:8080/api/task-steps/1/complete
Content-Type: application/json
Authorization: Bearer {{user_token}}

{
  "taskId": 1,
  "userId": 2
}

### ===================================================================
### VERWALTUNG VON WORKFLOW-VORLAGEN (Manager)
### ===================================================================

### Ruft alle verfügbaren Workflow-Vorlagen ab
# Wird vom Frontend benötigt, um dem Manager eine Liste zur Auswahl anzuzeigen,
# wenn er einen neuen Task erstellen will.
GET http://localhost:8080/api/workflow-definitions
Authorization: Bearer {{manager_token}}


### Ruft die Details einer spezifischen Workflow-Vorlage ab
# Nützlich zum Anzeigen von Details einer Vorlage. Wir testen mit ID 1.
GET http://localhost:8080/api/workflow-definitions/1
Authorization: Bearer {{manager_token}}


### Erstellt eine neue Workflow-Vorlage
# HINWEIS: Dieser Endpunkt erwartet eine komplexe JSON-Struktur, die auch die Schritte enthält.
# Für den Prototyp ist dieser Endpunkt weniger kritisch als die GET-Endpunkte.
POST http://localhost:8080/api/workflow-definitions
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "name": "Neuer Marketing Prozess",
  "description": "Ein Prozess für neue Marketing-Kampagnen.",
  "tenant": {
    "id": 1
  },
  "steps": [
    {
      "name": "Konzept erstellen",
      "description": "Erstes Konzept der Kampagne entwerfen.",
      "durationHours": 16,
      "sequenceOrder": 0,
      "requiredRole": {
        "id": 2
      }
    },
    {
      "name": "Freigabe einholen",
      "description": "Freigabe vom Management einholen.",
      "durationHours": 4,
      "sequenceOrder": 1,
      "requiredRole": {
        "id": 1
      }
    }
  ]
}

### ===================================================================
### ROLLEN-VERWALTUNG (durch Manager)
### ===================================================================
# Alle diese Endpunkte erfordern einen Manager-Token.

### Ruft alle verfügbaren Rollen ab
# Wird vom Frontend für das "Create/Update User"-Formular benötigt.
GET http://localhost:8080/api/roles
Authorization: Bearer {{manager_token}}


### Ruft eine einzelne Rolle anhand ihrer ID ab
# Nützlich, um Details einer Rolle zu sehen. Wir testen mit ID 1 (WORKFLOW_MANAGER).
GET http://localhost:8080/api/roles/1
Authorization: Bearer {{manager_token}}


### Erstellt eine neue Rolle
POST http://localhost:8080/api/roles
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "name": "SUPPORT_AGENT",
  "description": "Bearbeitet Kundenanfragen",
  "tenantId": 1
}


### Aktualisiert eine bestehende Rolle
# Wir testen mit der Rolle, die wir eben erstellt haben (Annahme: sie hat die ID 4).
PUT http://localhost:8080/api/roles/4
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "name": "HUMAN_RESOURCES",
  "description": "Verantwortlich für alle Personalangelegenheiten und das Recruiting."
}


### Weist einem Benutzer eine neue Rolle zu
# Simuliert, dass dem "tester" (User ID 3) die neue Rolle "HUMAN_RESOURCES" (Rollen ID 4) zugewiesen wird.
# HINWEIS: Hierfür muss noch ein Endpunkt im RoleController erstellt werden.
# POST http://localhost:8080/api/roles/assign
# Content-Type: application/json
# Authorization: Bearer {{manager_token}}
#
# {
#   "userId": 3,
#   "roleId": 4
# }


### Löscht eine Rolle
# Wir löschen die Rolle, die wir erstellt haben (ID 4).
DELETE http://localhost:8080/api/roles/4
Authorization: Bearer {{manager_token}}

### ===================================================================
### MANDANTEN-VERWALTUNG (Tenant Management)
### ===================================================================

### Erstellt einen neuen Mandanten
POST http://localhost:8080/api/tenants
Content-Type: application/json
Authorization: Bearer {{manager_token}}

{
  "name": "Neue Firma GmbH",
  "subdomain": "neuefirma"
}

### Ruft alle Mandanten ab
GET http://localhost:8080/api/tenants
Authorization: Bearer {{manager_token}}

### ===================================================================
### ECHTZEIT-BENACHRICHTIGUNGEN (WebSocket)
### ===================================================================

# HINWEIS: Diese Funktionalität kann nicht direkt in dieser Datei getestet werden.
# Sie dient als Dokumentation für das Frontend.

# 1. Verbindung herstellen
# Ein Client muss sich über SockJS mit dem folgenden Endpunkt verbinden:
# URL: http://localhost:8080/ws

# 2. Ein Thema abonnieren
# Um Updates für einen bestimmten Task zu erhalten, muss der Client das entsprechende Topic abonnieren.
# Beispiel für Task mit ID 1:
#Topic: /topic/tasks/1/updates

# 3. Nachrichten empfangen
# Das Backend sendet bei bestimmten Aktionen automatisch eine JSON-Nachricht an das Topic.

# Beispiel-Nachricht nach "completeStep":
# {
#   "message": "Arbeitsschritt 'Analyse und Design' wurde abgeschlossen.",
#   "taskId": 1,
#   "completedStepId": 1,
#   "newOverallTaskStatus": "IN_PROGRESS"
# }

# Beispiel-Nachricht nach "setManualPriority":
# {
#   "message": "Die Priorität für Schritt 'Implementierung' wurde manuell geändert.",
#   "taskStepId": 2,
#   "newPriority": "IMMEDIATE"
# }